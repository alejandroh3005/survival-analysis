---
title: "BIOST 537: Homework 2"
subtitle: "Department of Biostatistics @ University of Washington"
author:
- Alejandro Hernandez
date: "Winter Quarter 2025"
output: pdf_document
---

```{r setup, include=F}
# Clear environment
rm(list=ls())

# Setup options
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE, results='hide')
options(knitr.kable.NA = '-', digits = 2)
labs = knitr::all_labels()
labs = labs[!labs %in% c("setup", "allcode")]
```

```{r load}
# Load relevant packages
library(survival)  # survival model
library(dplyr)  # data manipulation
library(knitr)  # pretty tables
library(ggplot2)  # data visualization
library(survminer)

# Load data
methadone <- read.csv("../data/methadone.csv")

# Handle missing data

```

## PROBLEM 1.

Consider the following trial data on time until relapse (in months) for patients in remission of acute myelogenous leukemia administered a maintenance chemotherapeutic agent or not:

Maintenance group: 9, 12, 13+, 18, 23, 28+, 31, 34, 45, 45+, 48, 161+.

Control group: 4, 5, 8, 8, 10+, 12, 16+, 23, 27, 30, 38, 43, 45.

```{r question-1}
#### Question 1 ####

# Maintenance group survival times
mtnc_surv <- survival::Surv(
  time = c(9,12,13,18,23,28,31,34,45,45,48,161),
  event = c(1,1,0,1,1,0,1,1,1,0,1,0))
# Control group survival times
ctrl_surv <- survival::Surv(
  time = c(4,5,8,8,10,12,16,23,27,30,38,43,45),
  event = c(1,1,1,1,0,1,0,1,1,1,1,1,1))
  
```

(a) Compute the Kaplan-Meier and Nelson-Aalen estimators by filling the following tables for the control and maintenance group.

```{r question-1a1, results='asis'}
# Survival table for treated
mtnc_fit <- survival::survfit(mtnc_surv ~ 1, conf.type = "log-log")
mtnc_surv_tab <- data.frame(summary(mtnc_fit)[c(2,3,4,6,8)]) 
mtnc_surv_tab$"d/n" <- with(mtnc_surv_tab, n.event / n.risk)
mtnc_surv_tab$"1-d/n" <- 1 - mtnc_surv_tab$"d/n"

mtnc_surv_tab[,c(1,2,3,6,7,4,5)] %>%
  knitr::kable(
    col.names = c("Time", "At risk (n)", "Events (d)", "d/n", "1-d/n", "K-M S(t)", 
                  "N-A H(t)"),
    caption = "Survival table of remission patients administered maintenance treatment.")

```

```{r question-1a2, results='asis'}
# Survival table for controls
ctrl_fit <- survfit(ctrl_surv ~ 1, conf.type = "log-log")
ctrl_surv_tab <- data.frame(summary(ctrl_fit)[c(2,3,4,6,8)]) 
ctrl_surv_tab$"d/n" <- with(ctrl_surv_tab, n.event / n.risk)
ctrl_surv_tab$"1-d/n" <- 1 - ctrl_surv_tab$"d/n"

ctrl_surv_tab[,c(1,2,3,6,7,4,5)] %>%
  kable(
    col.names = c("Time", "At risk (n)", "Events (d)", "d/n", "1-d/n", "K-M S(t)",
                  "N-A H(t)"),
    caption = "Survival table of remission patients administered a control treatment.")

```

(b) For each group, what is the estimated probability that no relapse will occur by 36 months?

```{r question-1b}
# Maintenance group
summary(mtnc_fit, times = 36) 
# Control group
summary(ctrl_fit, times = 36) 

```

We fit two nonparametric Kaplan-Meier models of time until relapse for patients in remission of acute myelogenous leukemia, based on whether they were administered a maintenance chemotherapeutic agent or not. Our target is each group's probability of reaching 36 months without relapsing. We estimate this probability to be 0.432 (95% CI\*: 0.141-0.698) among the maintenance group and 0.303 (95% CI\*: 0.076-0.574) among the control group.

\* Confidence intervals were computed using the "complementary log-log" technique, to ensure they fall within the [0,1] interval.

## PROBLEM 2.

In this problem, you will revisit the dataset on methadone maintenance for heroin addicts, as studied in Problem Set 1. Please refer to that homework for a description of the relevant variables.

(a) Plot the Kaplan-Meier estimator of the survival function of the time until exit from maintenance along with pointwise 95% confidence intervals. What is the estimated probability that no exit will occur by one year? Provide a 95% confidence interval for your answer.

```{r question-2a, fig.asp=1, fig.cap="Time from entry to exit from methadone maintenence. Survival is modeled by a nonparametric Kaplan-Meier estimator."}
#### QUESTION 2 ####
# Plot K-M estimator of survival
meth_surv <- with(methadone, Surv(time, event))
meth_fit <- survfit(meth_surv ~ 1, data = methadone, conf.type = "log-log")
plot(meth_fit, conf.int = TRUE, col = "darkblue",
     ylab = "Survival function", xlab = "Time (days)")

# Estimate survival to one year
summary(meth_fit, times = 365)

```
We fit a Kaplan-Meier model of time from entry to exit from methadone maintenance. We estimate the probability of reaching 1 year without exiting is 0.606 (95% clog-log CI: 0.538-0.667).

```{r question-2a-supplementary}
# # With ggplot
# survminer::ggsurvplot(meth_fit, data=methadone, ggtheme=theme_bw(), 
#                     conf.int=TRUE, xlab="", ylab="")
# ggsurvplot(meth_fit, data=methadone, ggtheme=theme_bw(), 
#            risk.table = TRUE, conf.int=TRUE, xlab="", ylab="")

# Facet
# survminer::ggsurvplot_facet(meth_fit, 
#                             facet.by=c("clinic"), # in data, not model
#               # facet.by is only for fit models that already have some covariate
#                             data=methadone)

# Other arguments
# censor = TRUE
# legend.labs = c("Survival Estimate")
# legend.title = ""
# legend = c(0.8, 0.8)
# palette = "purple"

```

(b) Provide the estimated median time until exit from maintenance and associated 95% confidence interval by:

i.  scrutinizing values of the Kaplan-Meier estimator and associated confidence intervals (explain how you obtain your answer);

ii. using the median estimate and confidence intervals provided by the `survfit` command.

```{r question-2b}
# Median estimate by survfit
meth_fit # complementary log-log CI

median(meth_surv) # untransformed CI
quantile(meth_fit, prob = 0.5) # using clog-log

```

The `survfit` function estimates the median time until exit from maintenance to be 504 days, approximately 1.4 years (95% CI: 394-550 days).

(c) In this part, you will investigate differences between patients with and without a history of incarceration.

i.  On the same graph, plot the Kaplan-Meier estimator of the survival function of the time until exit from maintenance for patients with a history of incarceration and for patient without.

```{r question-2ci, fig.asp=1, fig.cap="Kaplan-Meier estimator of time until exit from maintenance for patients with and without a history of incarceration."}
## Plot KM estimator for patients with and without a history of incarceration
meth_fit2 <- survfit(meth_surv ~ prison, conf.type = "log-log", data = methadone) 
meth_fit2 %>% 
  plot(xlab = "Time (days)", ylab = "Survival function", conf.int = TRUE,
       col = c("darkblue", "lightblue"))
legend(500, 0.97, fill = c("darkblue", "lightblue"), bty = "n",
       legend = c("History of incarceration","No history of incarceration"))

```

Investigators followed a cohort of 238 individuals with heroin use disorder who entered methadone maintenance programs in either of two clinics in Sydney, Australia over an 18-month period during the late 1980s. The purpose of the study was to identify factors associated to retention in methadone maintenance. Time from entry into the study to exit from methadone maintenance is the duration of interest. More details can be found in Caplehorn and Bell (1991).

From the 238 individuals enrolled in this study, we fit two non-parametric models of time from entry into the study to exit from methadone maintenance: one for patients from with a history of incarceration and another for patients without a history of incarceration; see Figure 1.

ii. Does the probability that no exit occurred by 8 months differ significantly between these two groups?

```{r question-2cii}
# Compare survival probability at 8 months
temp <- summary(meth_fit2, times = 8*30)
wald_tstat <- abs(diff(temp$surv)) / sqrt(sum(temp$std.err^2))
pval <- 2 * pnorm(wald_tstat, lower.tail = FALSE)
# "If the p is low, the null must go!"
pval < 0.05  # FALSE

```

iii. Based on the log-rank test, does the distribution of time until exit from maintenance differ significantly by history of incarceration?

```{r question-2ciii}
# Log-rank test of significance of prison coefficient
survival::survdiff(meth_surv ~ prison, data = methadone)

```

A log-rank test determined there is insufficient evidence in our sample that time from entry into the study to exit from methadone maintenance differs significantly between patients with and without a history of incarceration at $\alpha$ = 5% (p=0.3).

iv. Based on the Wilcoxon-Gehan-Breslow test, does the distribution of time until exit from maintenance differ significantly by history of incarceration?

```{r question-2civ}

```

v.  Plot estimated hazard functions for patients with and without a history of incarceration. Briefly indicate how this plot may inform you regarding the power of the logrank test as well as expected differences in the magnitude of the chi-square statistics from the logrank and Wilcoxon-Gehan-Breslow tests.

```{r question-2cv}

```

(d) Repeat (c) but substituting history of incarceration by methadone dosage dichotomized at 60mg/day (i.e., compare the subpopulation of patients administered more than 60mg/day of methadone to the subpopulation of patients administered no more than 60 mg/day).

```{r question-2d}
# Plot KM estimator for patients with dosage above versus below 60 mg/day
methadone$dose.bin <- ifelse(methadone$dose > 60, 1, 0)

fit3 <- survfit(meth_surv ~ dose.bin, conf.type = "log-log", data = methadone) 
fit3 %>% plot(xlab = "Time (days)", ylab = "Survival function")

# Compare survival probability at 8 months
summary(fit3, times = 8*30)

# Log-rank test of significance of dosage coefficient
survdiff(meth_surv ~ dose.bin, data = methadone)

```

(e) Based on a stratified log-rank test, does the time until exit from maintenance differ by history of previous incarceration adjusting for clinic membership? State explicitly what the null and alternative hypotheses are and contrast with what they are in a standard log-rank test.

```{r question-2e}
# Stratified log-rank test of significance of prison coefficient adjusting for clinic
survdiff(meth_surv ~ dose.bin + strata(clinic), data = methadone)

```

(f) What is the estimated median residual time until exit from maintenance at 4, 8 and 12 months? Calculate these estimates using only values of the Kaplan-Meier estimator. Verify your answer using the R function provided for this purpose, and obtain 95% confidence intervals to accompany your estimates.

```{r question-2f}

```

**End of report. Code appendix begins on the next page.**

\pagebreak

## Code Appendix

```{r allcode, ref.label = knitr::all_labels(), echo=TRUE, eval=FALSE}
```

**End of document.**
